services:
  reverse_proxy:
    image: docker.io/library/traefik:v2.10
    command:
      - --api.insecure=true
      - --providers.file=true
      - --providers.file.filename=/etc/traefik/rules.yaml
      - --providers.file.watch=true
      - --entrypoints.web.address=:80
    ports:
      - 8088:80
      - 8080:8080
    volumes:
      - './util/traefik/rules.yaml:/etc/traefik/rules.yaml'
    networks:
      - klicker

  # main database
  postgres:
    image: docker.io/library/postgres:15
    environment:
      POSTGRES_USER: klicker
      POSTGRES_PASSWORD: klicker
      POSTGRES_DB: main
    ports:
      - 5432:5432
    networks:
      - klicker
    volumes:
      - /var/lib/postgresql/data

    # redis instance to support session execution
  redis_exec:
    image: docker.io/library/redis:7
    ports:
      - 6379:6379
    networks:
      - klicker
    volumes:
      - /data

  # redis instance for page caching and rate limiting
  redis_cache:
    image: docker.io/library/redis:7
    ports:
      - 6380:6379
    networks:
      - klicker

  sendria:
    image: msztolcman/sendria:v2.2.2.0
    ports:
      - 1025:1025
      - 1080:1080
    networks:
      - klicker

  frontend_pwa:
    profiles:
      - full
    build:
      context: .
      dockerfile: apps/frontend-pwa/Dockerfile
      args:
        NODE_ENV: development
        COOKIE_DOMAIN: 127.0.0.1
        NEXT_PUBLIC_ADD_RESPONSE_URL: 'http://127.0.0.1:7072/api/AddResponse'
        NEXT_PUBLIC_API_URL: 'http://127.0.0.1:3000/api/graphql'
        NEXT_PUBLIC_API_URL_SSR: 'http://backend:3000/api/graphql'
    environment:
      APP_SECRET: abcd
    ports:
      - 3001:3000
    networks:
      - klicker

  frontend_manage:
    profiles:
      - full
    build:
      context: .
      dockerfile: apps/frontend-manage/Dockerfile
      args:
        NODE_ENV: development
        COOKIE_DOMAIN: 127.0.0.1
        NEXT_PUBLIC_API_URL: 'http://127.0.0.1:3000/api/graphql'
        NEXT_PUBLIC_API_URL_SSR: 'http://backend:3000/api/graphql'
    ports:
      - 3002:3000
    networks:
      - klicker

  frontend_control:
    profiles:
      - full
    build:
      context: .
      dockerfile: apps/frontend-control/Dockerfile
      args:
        NODE_ENV: development
        COOKIE_DOMAIN: 127.0.0.1
        NEXT_PUBLIC_API_URL: 'http://127.0.0.1:3000/api/graphql'
        NEXT_PUBLIC_API_URL_SSR: 'http://backend:3000/api/graphql'
    ports:
      - 3003:3000
    networks:
      - klicker

  backend:
    profiles:
      - full
    build:
      context: .
      dockerfile: apps/backend-docker/Dockerfile
      args:
        NODE_ENV: 'development'
    environment:
      DATABASE_URL: 'postgres://klicker:klicker@postgres:5432/main'
      APP_SECRET: 'abcd'
      REDIS_HOST: 'redis_exec'
      REDIS_PORT: 6379
      REDIS_CACHE_HOST: 'redis_cache'
      REDIS_CACHE_PORT: 6379
      API_DOMAIN: '127.0.0.1'
      COOKIE_DOMAIN: '127.0.0.1'
    ports:
      - 3000:3000
    networks:
      - klicker

networks:
  klicker:
    driver: bridge
